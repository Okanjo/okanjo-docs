<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Events (BETA) : Okanjo API Core Specification</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="assets_/css/shCore.css">
        <link rel="stylesheet" href="assets_/css/shThemeDefault.css">
        <link rel="stylesheet" href="assets_/css/main.css">
    </head>
    <body data-root-path="">
        <div id="wrapper">
            <div id="content">
<ul id="topnav">
    <li><a href="index.html">Index</a></li>
    <li><a href="#toc">TOC</a></li>
</ul>
<h1 id="eventsbeta">Events (BETA)</h1>

<p>An Event resource is generated when something occurs on the Okanjo platform. Events can pass along greatly differing data
sets, but all will be centered around the event that took place. For example, an order that was updated will be sent when
an <code>order.updated</code> event occurs). Data about these events are transmitted by webhook to a third party URL at their request.</p>

<blockquote>
  <p>Note: Events and Webhooks are currently in beta. Design may change in the future and not all events are available for webhooks. Please let us know your experience using Okanjo Events.</p>
  
  <p>Note: Webhooks are only available to marketplaces. In the future, we will make webhooks available to users and stores.</p>
</blockquote>

<h2 id="tableofcontentsahreftocnametocclassdeeplinka">Table of Contents <a href="#toc" name="toc" class="deep-link">#</a></h2>

<ul>
<li><a href="#Workflow Example">Workflow Example</a></li>
<li><a href="#Acknowledgement and Retries">Acknowledgement and Retries</a></li>
<li><a href="#Security Considerations">Security Considerations</a></li>
<li><a href="#Node.js Example Listener">Node.js Example Listener</a></li>
<li><a href="#GET /events/{id}">GET /events/{id}</a></li>
<li><a href="#GET /events/subscriptions">GET /events/subscriptions</a></li>
<li><a href="#POST /events/subscribe">POST /events/subscribe</a></li>
<li><a href="#POST /events/unsubscribe">POST /events/unsubscribe</a></li>
</ul>

<h2 id="workflowexampleahrefworkflowexampleidworkflowexampleclassdeeplinka">Workflow Example <a href="#Workflow Example" id="Workflow Example" class="deep-link">#</a></h2>

<p>For this example, we're going to subscribe to the event that is triggered whenever a user uploads a product to Okanjo.</p>

<p>First, make sure you have your destination endpoint and URL in place. For this example we're using
<a href="http://requestb.in">Request Bin</a>, so we can see the POST data we're sent. This is important because
Okanjo will test the URL you give it before letting you subscribe to an event. Now that you're ready to
subscribe to an event, send a POST request to <code>/events/subscribe</code> with the <code>type</code> and <code>webhook_url</code> entity data:</p>

<pre><code>type=product.created
webhook_url=http://requestb.in/u2nxcmu2
</code></pre>

<p>If this was done properly, you will receive the default <a href="Globals.html#Default Response Object"><code>Success</code></a> object:</p>

<pre class="brush:js">

{
  "type": "success"
}
</pre>

<p>Now, whenever a product is added to your marketplace, the Okanjo will send information about the event to
your webhook URL. The contents will look something like this, which will include the product information in the <code>data</code> section:</p>

<pre class="brush:js">

{
  "id": "EV3KtarTnr6R1hJ6jjoq",
  "occurred": "2014-11-06 14:39:43",
  "type": "product.created",
  "data": {
    "id": "141751",
    "curated": null,
    "donation_perc": "15",
    "status": "1",
    "seller_store_id": "5164",
    "brand_id": "1",
    "location_zip": "53022",
    "location_name": "Germantown",
    "location_state": "WI",
    "stock": null,
    "category_id": "265",
    "cause_id": "35882",
    "is_local_pickup": "0",
    "is_free_shipping": "1",
    "thumbnail_media_id": "281789",
    "created": "2014-11-06 14:39:43",
    "published": "2014-11-06 14:39:43",
    "updated": "2014-11-06 14:39:43",
    "price": "5.00",
    "slug": "141751-half-life-2-supply-crate",
    "title": "Half-Life 2 Supply Crate",
    "description": "This is a supply crate from Half-Life. Break it open to see what's inside!",
    "condition": "New",
    "is_vertical": "0",
    "current_bid": null,
    "auction_start": null,
    "auction_end": null,
    "auction_min_bid": null,
    "type": "0",
    "return_policy_id": "1",
    "is_available": "1",
    "deal_start": null,
    "deal_end": null,
    "promo_start": null,
    "promo_end": null,
    "deal_value": null,
    "dma_code": "617",
    "dimensions": {
      "Contents": {
        "Health": {
          "price_modifier": "0"
        },
        "Ammo": {
          "price_modifier": "0"
        },
        "Energy": {
          "price_modifier": "0"
        }
      }
    },
    "variants": {
      "Contents=Health": {
        "stock": ""
      },
      "Contents=Ammo": {
        "stock": ""
      },
      "Contents=Energy": {
        "stock": ""
      }
    },
    "category": {
      "id": "265",
      "parent_id": "238",
      "port": "300",
      "starboard": "301",
      "depth": "3",
      "name": "Games",
      "parents": "5,238"
    },
    "cause": {
      "id": "35882",
      "status": "2",
      "name": "The Breast Cancer Society Inc",
      "local_name": "The Breast Cancer Society Inc (Mesa)",
      "city": "Mesa",
      "state": "AZ",
      "created": "2014-08-01 08:56:47",
      "updated": "2014-08-01 08:56:47",
      "store_id": "5200",
      "store_about": "The guiding mission of The Breast Cancer Society, Inc. (The BCS) is to provide relief to those who suffer from the effects of breast cancer now, as well as to work cooperatively with and give support to other personnel, individuals and organizations that share in the goal of helping cancer patients, the critically ill, and the impoverished. This is done through such means as education, direct assistance, financial aid, and the providing of supplies and care-giving products, and referral services. Additionally, The BCS assist in the eradication of breast cancer through education and the support of breast cancer research.",
      "store_website_url": null,
      "store_facebook_url": null,
      "store_twitter_url": null,
      "store_avatar_media_id": null,
      "store_banner_media_id": null,
      "store_okanjo_uri": null
    },
    "store": {
      "id": "5164",
      "status": "1",
      "created": "2014-05-12 16:38:15",
      "updated": "2014-05-12 16:38:15",
      "type": "1",
      "name": "waynefsmith",
      "about": null,
      "website_url": null,
      "facebook_url": null,
      "twitter_url": null,
      "avatar_media_id": null,
      "banner_media_id": null,
      "rating_avg": null,
      "okanjo_uri": null
    },
    "shipping": null,
    "tags": {
      "5": {
        "id": "5",
        "name": "Entertainment"
      },
      "54": {
        "id": "54",
        "name": "Games"
      },
      "63": {
        "id": "63",
        "name": "Videogames"
      }
    },
    "return_policy": {
      "id": "1",
      "store_id": "0",
      "name": "No Returns",
      "policy": "Returns not accepted"
    },
    "media": {
      "281789": {
        "original": "https:\/\/dj01gpsbn30ii.cloudfront.net\/sandbox_9ii4h_281789_desktop_original.jpg",
        "cart_desktop": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=desktop&#38;amp;size=cart",
        "cart_desktop_width": null,
        "cart_desktop_height": null,
        "cart_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=cart",
        "cart_mobile_retina_width": null,
        "cart_mobile_retina_height": null,
        "detail_desktop": "https:\/\/dj01gpsbn30ii.cloudfront.net\/sandbox_l7j1q_281789_desktop_detail.jpg",
        "detail_desktop_width": "1074",
        "detail_desktop_height": "808",
        "detail_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=detail",
        "detail_mobile_retina_width": null,
        "detail_mobile_retina_height": null,
        "gallery_desktop": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=desktop&#38;amp;size=gallery",
        "gallery_desktop_width": null,
        "gallery_desktop_height": null,
        "gallery_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=gallery",
        "gallery_mobile_retina_width": null,
        "gallery_mobile_retina_height": null,
        "listing_desktop": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=desktop&#38;amp;size=listing",
        "listing_desktop_width": null,
        "listing_desktop_height": null,
        "listing_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=listing",
        "listing_mobile_retina_width": null,
        "listing_mobile_retina_height": null,
        "listing_fixed_desktop": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=desktop&#38;amp;size=listing_fixed",
        "listing_fixed_desktop_width": null,
        "listing_fixed_desktop_height": null,
        "listing_fixed_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=listing_fixed",
        "listing_fixed_mobile_retina_width": null,
        "listing_fixed_mobile_retina_height": null,
        "thumbnail_desktop": "https:\/\/dj01gpsbn30ii.cloudfront.net\/sandbox_b67g0_281789_desktop_thumbnail.jpg",
        "thumbnail_desktop_width": "130",
        "thumbnail_desktop_height": "130",
        "thumbnail_mobile_retina": "https:\/\/sandbox-api.okanjo.com\/media\/generate?id=281789&#38;amp;format=mobile_retina&#38;amp;size=thumbnail",
        "thumbnail_mobile_retina_width": null,
        "thumbnail_mobile_retina_height": null
      }
    },
    "meta": [

    ]
  }
}
</pre>

<h2 id="acknowledgementandretriesahrefacknowledgementandretriesidacknowledgementandretriesclassdeeplinka">Acknowledgement and Retries <a href="#Acknowledgement and Retries" id="Acknowledgement and Retries" class="deep-link">#</a></h2>

<p>A webhook is considered to be successfully delivered if the HTTP response code received is a <code>200</code>-level status code.
<code>301</code>, <code>302</code> and <code>303</code> status codes will be followed and retried automatically, however no more than three follow attempts will be performed.
Any other status code received will be considered to be a failure.</p>

<p>Failed webhooks will be retried up to 30 times on an exponentially-increasing delay.
The number of minutes between each retry can be calculated as 2<sup>(n-1)</sup> or 64, which ever is least.
This means that webhooks will continue to be attempted over a 26.5 hour span. If you experience an outage longer than
this duration, please contact Okanjo support for assistance replaying lost webhooks.</p>

<blockquote>
  <p>Note: Due to the nature of the Internet, webhooks are not atomic. Okanjo does not guarantee that webhooks will be received in the order they occurred.</p>
</blockquote>

<h2 id="securityconsiderationsahrefsecurityconsiderationsidsecurityconsiderationsclassdeeplinka">Security Considerations <a href="#Security Considerations" id="Security Considerations" class="deep-link">#</a></h2>

<p>While you can process the event as-is, our security conscientious folks will want to verify
that the event was really sent from Okanjo. To do so, send a <code>GET</code> request to <code>events/&lt;event_id&gt;</code>, where <code>&lt;event_id&gt;</code>
in this case is the ID from above, <code>EV3KtarTnr6R1hJ6jjoq</code>. If done properly, the response you get will exactly match
the data you received via webhook.</p>

<p>Webhook requests should originate from one of following IP addresses:</p>

<ul>
<li><code>96.30.254.41</code></li>
<li><code>96.30.254.43</code></li>
</ul>

<p>These addresses should not change, but if they do they will be reported here.</p>

<h2 id="nodejsexamplelistenerahrefnodejsexamplelisteneridnodejsexamplelistenerclassdeeplinka">Node.js Example Listener <a href="#Node.js Example Listener" id="Node.js Example Listener" class="deep-link">#</a></h2>

<p>We've created a couple of Node.js webhook listeners that you may use as a starting point for implementing webhooks on your platform.</p>

<ul>
<li><a href="https://github.com/Okanjo/okanjo-nodejs/blob/master/examples/webhooks.js">Basic Example</a></li>
<li><a href="https://github.com/Okanjo/okanjo-nodejs/blob/master/examples/webhooks-verify.js">Trust but Verify Example</a></li>
</ul>

<h3 id="exampleoutput">Example Output</h3>

<pre><code>[2014-11-07 16:19:22] GOT NEW ORDER EVENT! EVBdExgKEVDb7bCzb1kY Id=32631, Items=1, Status=1
[2014-11-07 16:30:32] GOT ITEM UPDATED EVENT! EVCnvVCk2Tk526uXTs6m Id=1552, OrderId=32678, Status=3
[2014-11-07 16:30:32] GOT ORDER UPDATED EVENT! EVA1uEpsGdoMjYqj2QBi Id=32678, Items=1, Status=2
[2014-11-07 16:30:50] GOT ITEM UPDATED EVENT! EV6y9bAeL2Wn88FNqexc Id=1549, OrderId=32630, Status=2
[2014-11-07 16:30:50] GOT ORDER UPDATED EVENT! EVUUWtURZn53GHJYW93 Id=32630, Items=1, Status=2
[2014-11-07 16:32:09] GOT ITEM UPDATED EVENT! EVio7P33B3jquAPbQae Id=1553, OrderId=32679, Status=2
[2014-11-07 16:32:09] GOT ORDER UPDATED EVENT! EVAGVkUMhKhsj2dnRdh6 Id=32679, Items=1, Status=2
[2014-11-07 16:32:43] GOT ORDER UPDATED EVENT! EV9ti2VTZbZ62Ua6vWLA Id=32631, Items=1, Status=2
[2014-11-07 16:32:43] GOT ITEM UPDATED EVENT! EVMhQdYpkRPvW4d5Ft8U Id=1550, OrderId=32631, Status=3
</code></pre>

<h1 id="objects">Objects</h1>

<ul>
<li><a href="Objects.html#Event"><code>Event</code></a> – Event object (transmitted to client)</li>
<li><a href="Objects.html#EventSubscription"><code>Event Subscription</code></a> - A subscription record for an event type to a URL</li>
</ul>

<h1 id="eventtypes">Event Types</h1>

<p>For a list of available event types, see <a href="Constants.html#EventType"><code>Event Types</code></a>.</p>

<h1 id="routes">Routes</h1>

<p>Here are the list of API routes to interact with events.</p>

<h2 id="geteventsidahrefgeteventsididgeteventsidclassdeeplinka">GET /events/{id} <a href="#GET /events/{id}" id="GET /events/{id}" class="deep-link">#</a></h2>

<p>Resource. Gets the event and associated data. A duplicate of what is sent by webhook.</p>

<h3 id="queryparameters">Query Parameters</h3>

<dl class="inline-def"><dt><p><code>embed</code></p></dt><dd><p><code>csv</code> When given, includes the additional linked resources. Accepts: <code>notifications</code>.</p></dd></dl>

<h3 id="returns">Returns</h3>

<p><a href="Objects.html#Event"><code>Event</code></a> Objects.</p>

<h4 id="errors">Errors</h4>

<dl><dt><p><strong>404 Not Found</strong></p></dt><dd><p><code>Event not found.</code>  Occurs when the event cannot be found.</p></dd></dl>

<h2 id="geteventssubscriptionsahrefgeteventssubscriptionsidgeteventssubscriptionsclassdeeplinka">GET /events/subscriptions <a href="#GET /events/subscriptions" id="GET /events/subscriptions" class="deep-link">#</a></h2>

<p>Collection. Gets all active subscriptions.</p>

<h3 id="queryparameters">Query Parameters</h3>

<p>None.</p>

<h3 id="returns">Returns</h3>

<p>Array of <a href="Objects.html#EventSubscription"><code>Event Subscription</code></a> objects.</p>

<h4 id="errors">Errors</h4>

<p>None.</p>

<h2 id="posteventssubscribeahrefposteventssubscribeidposteventssubscribeclassdeeplinka">POST /events/subscribe <a href="#POST /events/subscribe" id="POST /events/subscribe" class="deep-link">#</a></h2>

<p>Controller. Subscribes a given event type to a supplied webhook URL.</p>

<h3 id="entitynvpparameters">Entity NVP Parameters</h3>

<p>Both of these parameters are mandatory.</p>

<dl class="inline-def"><dt><p><code>type</code></p></dt><dd><p><code>string</code> The type of event to subscribe to.</p></dd><dt><p><code>webhook_url</code></p></dt><dd><p><code>string</code> The URL (including scheme).</p></dd></dl>

<blockquote>
  <p>Note:  You may use <code>*</code> to subscribe to all available events. This functionality may be changed or expanded in the future.</p>
</blockquote>

<h3 id="returns">Returns</h3>

<p>Generic <a href="Globals.html#Default Response Object"><code>Success</code></a> object.</p>

<h4 id="errors">Errors</h4>

<dl><dt><p><strong>400 Bad Request</strong></p></dt><dd><p><code>Require {field}.</code>  Occurs when you're missing a necessary NVP parameter.</p></dd><dd><p><code>Invalid field {field}.</code>  Occurs when you have an invalid <code>type</code> field or Okanjo failed to POST to the supplied <code>webhook_url</code>, or if it was malformed.</p></dd><dt><p><strong>409 Conflict</strong></p></dt><dd><p><code>Conflict with Event Subscription</code>  Occurs when trying to subscribe to an event <code>type</code> with the same <code>webhook_url</code>.</p></dd><dt><p><strong>500 Internal Server Error</strong></p></dt><dd><p><code>Unable to handle request.</code>  Occurs when there's a system failure while attempting to subscribe to an event.</p></dd></dl>

<h2 id="posteventsunsubscribeahrefposteventsunsubscribeidposteventsunsubscribeclassdeeplinka">POST /events/unsubscribe <a href="#POST /events/unsubscribe" id="POST /events/unsubscribe" class="deep-link">#</a></h2>

<p>Resource. Subscribes a given event type to a supplied webhook URL.</p>

<h3 id="entitynvpparameters">Entity NVP Parameters</h3>

<p>Both of these parameters are mandatory.</p>

<dl class="inline-def"><dt><p><code>type</code></p></dt><dd><p><code>string</code> The type of event to subscribe to.</p></dd><dt><p><code>webhook_url</code></p></dt><dd><p><code>string</code> The URL (including scheme).</p></dd></dl>

<h3 id="returns">Returns</h3>

<p>Generic <a href="Globals.html#Default Response Object"><code>Success</code></a> object.</p>

<h4 id="errors">Errors</h4>

<dl><dt><p><strong>400 Bad Request</strong></p></dt><dd><p><code>Require {field}.</code>  Occurs when you're missing a necessary NVP parameter.</p></dd><dd><p><code>Invalid field {field}.</code>  Occurs when you have an invalid <code>type</code> field or malformed <code>webhook_url</code>.</p></dd><dt><p><strong>404 Not Found</strong></p></dt><dd><p><code>Event Subscription not found.</code>  Occurs when the event cannot be found.</p></dd><dt><p><strong>500 Internal Server Error</strong></p></dt><dd><p><code>Unable to handle request.</code>  Occurs when there's a system failure while attempting to subscribe to an event.</p></dd></dl>
                <hr />
                <small>Documentation generated by <a target="_blank" href="https://github.com/kfitzgerald/mdoc">mdoc</a>.</small>
            </div>
        </div>
        <script src="assets_/js/lib/jquery.js"></script>
        <script src="assets_/js/lib/syntax-highlighter/shCore.js"></script>
        <script src="assets_/js/lib/syntax-highlighter/shAutoloader.js"></script>
        <script src="assets_/js/main.js"></script>
        <script>

            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-36849843-8', 'auto');
            ga('send', 'pageview');

        </script>
    </body>
</html>
